# セッション間調整ルール

## 目的

複数のClaude Codeセッションが同時に動作する際、作業の重複・衝突を防ぐ。

---

## 🚨 必須ルール：作業開始前チェック

### 1. `DOING.md` を必ず確認

```bash
cat DOING.md
```

- **他のセッションが同じタスクを実行中か確認**
- 実行中なら、そのセッションの作業完了を待つ
- 緊急でない限り、同じフィーチャーに手を出さない

### 2. Git ブランチ確認

```bash
git branch -a
```

- 同じフィーチャーブランチが既に存在するか確認
- 存在する場合、そのブランチの最新コミットを確認
- 他セッションが作業中の可能性大

### 3. 最新のコミットログ確認

```bash
git log --oneline -5
```

- 直近5分以内のコミットがあれば、他セッション稼働中
- コミットメッセージから作業内容を把握

---

## 📝 作業開始時の報告（DOING.md更新）

作業を開始する際、**必ず** `DOING.md` に記録：

```markdown
## [セッションID] - [開始時刻]

- **Feature**: F00X - フィーチャー名
- **Status**: 🔄 作業中
- **担当フェーズ**: 実装 / テスト / PR作成
- **予定完了時刻**: HH:MM
- **備考**:

---
```

### セッションID取得方法

自分のセッションIDを確認：
```bash
echo $CLAUDE_SESSION_ID
```

なければ、タイムスタンプを使用：
```bash
date +"%Y%m%d-%H%M%S"
```

---

## ✅ 作業完了時の報告

作業完了後、`DOING.md` を更新：

```markdown
## [セッションID] - [完了時刻]

- **Feature**: F00X - フィーチャー名
- **Status**: ✅ 完了
- **成果物**: PR#XX, コミットハッシュ, etc.
- **次のアクション**: レビュー待ち / マージ待ち

---
```

---

## 🔄 並行作業時のルール

### ケース1: 同じフィーチャーを別フェーズで担当

✅ **許可**

- セッションA: 実装担当
- セッションB: PR作成担当

**条件**:
- `DOING.md`で明確に役割分担
- 相互に進捗確認

### ケース2: 同じフィーチャーの同じフェーズ

❌ **禁止**

- 重複作業になる
- どちらかが待機するか、別タスクへ

### ケース3: 別フィーチャー

✅ **許可**

- F006とF007など、依存関係がなければ並行作業OK

---

## 🚨 緊急時の対応

### 衝突が発生した場合

1. **即座に報告**: `DOING.md`に「⚠️ 衝突発生」と記載
2. **一時停止**: 作業を止める
3. **調整**: どちらのセッションが続行するか決定
4. **ロールバック**: 必要であればコミットをrevert

---

## 📋 チェックリスト（作業開始時）

コピペして毎回確認：

```
[ ] DOING.mdを読んだ
[ ] 同じフィーチャーを他セッションが担当していないか確認
[ ] git branchで既存ブランチ確認
[ ] git logで直近のコミット確認
[ ] DOING.mdに自分の作業を記録
[ ] 作業開始
```

---

## 🛠️ ツール化（推奨）

`.claude/scripts/check-session.sh` を作成：

```bash
#!/bin/bash
echo "=== セッション調整チェック ==="
echo ""
echo "📄 DOING.md:"
cat DOING.md 2>/dev/null || echo "DOING.mdが存在しません"
echo ""
echo "🌿 Git ブランチ:"
git branch -a | grep feature
echo ""
echo "📝 最新5コミット:"
git log --oneline -5
echo ""
echo "⚠️ 他セッションが作業中の場合、待機してください"
```

使い方：
```bash
bash .claude/scripts/check-session.sh
```

---

## 📌 重要な原則

1. **報連相 > スピード**: 早く終わらせることより、調整を優先
2. **DOING.mdは真実**: 常に最新状態を保つ
3. **疑わしきは確認**: 少しでも衝突の可能性があれば、先に確認
4. **PR作成は最後の砦**: 特に慎重に確認

---

## 更新履歴

| Date | Change |
|------|--------|
| 2026-02-09 | 初版作成 - セッション調整ルール策定 |
